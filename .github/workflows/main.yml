name: Update Configs

on:
  schedule:
    - cron: '30 22 * * *' # UTC 22:30 = åŒ—äº¬æ—¶é—´æ¬¡æ—¥ 06:30
  workflow_dispatch:
    inputs:
      category:
        description: 'é€‰æ‹©è¦æ›´æ–°çš„ç±»åˆ«'
        required: false
        type: choice
        options: [all, official, general, smart, mobile]
        default: all

permissions:
  contents: write

jobs:
  update-configs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Update configs (parallel + hash)
        run: |
          set -euo pipefail

          ########################################
          # åŸºç¡€å·¥å…·å‡½æ•°
          ########################################

          fetch_if_changed() {
            local url="$1"
            local target="$2"

            mkdir -p "$(dirname "$target")"
            local tmp
            tmp="$(mktemp)"

            if ! curl -fsSL "$url" -o "$tmp"; then
              echo "âŒ ä¸‹è½½å¤±è´¥: $url"
              rm -f "$tmp"
              return 1
            fi

            if [ ! -f "$target" ]; then
              mv "$tmp" "$target"
              echo "ğŸ†• æ–°æ–‡ä»¶: $target"
              return 0
            fi

            local old_hash new_hash
            old_hash="$(sha256sum "$target" | awk '{print $1}')"
            new_hash="$(sha256sum "$tmp" | awk '{print $1}')"

            if [ "$old_hash" = "$new_hash" ]; then
              rm -f "$tmp"
              echo "â­ï¸ æœªå˜åŒ–: $target"
            else
              mv "$tmp" "$target"
              echo "ğŸ”„ å·²æ›´æ–°: $target"
            fi
          }

          ########################################
          # å¹¶è¡Œè°ƒåº¦å™¨
          ########################################

          MAX_JOBS=4
          running=0
          pids=()

          run_parallel() {
            "$@" &
            pids+=($!)
            ((running++))

            if (( running >= MAX_JOBS )); then
              wait -n
              ((running--))
            fi
          }

          ########################################
          # åˆ†ç±»åˆ¤æ–­
          ########################################

          should_run() {
            local cat="$1"
            if [[ "${{ github.event_name }}" == "schedule" ]] ||
               [[ "${{ github.event.inputs.category || 'all' }}" == "all" ]] ||
               [[ "${{ github.event.inputs.category || 'all' }}" == "$cat" ]]; then
              return 0
            fi
            return 1
          }

          ########################################
          # Official
          ########################################

          if should_run "official"; then
            run_parallel fetch_if_changed \
              "https://wiki.metacubex.one/example/mrs" \
              "Official_Examples/Metacubex/rule-set_config.yaml"

            run_parallel fetch_if_changed \
              "https://wiki.metacubex.one/example/geox" \
              "Official_Examples/Metacubex/geox_config.yaml"
          fi

          ########################################
          # General / Smart / Mobile
          # ï¼ˆè„šæœ¬å†…éƒ¨åŒæ ·åº”ä½¿ç”¨ fetch_if_changedï¼‰
          ########################################

          if should_run "general" && [ -f .github/scripts/download-general.sh ]; then
            bash .github/scripts/download-general.sh
          fi

          if should_run "smart" && [ -f .github/scripts/download-smart.sh ]; then
            bash .github/scripts/download-smart.sh
          fi

          if should_run "mobile" && [ -f .github/scripts/download-mobile.sh ]; then
            bash .github/scripts/download-mobile.sh
          fi

          ########################################
          # ç­‰å¾…æ‰€æœ‰å¹¶è¡Œä»»åŠ¡
          ########################################

          wait

      - name: Commit only if configs changed
        run: |
          set -e

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # åª add é…ç½®ç›®å½•ï¼ˆæ— å™ªéŸ³å…³é”®ï¼‰
          for dir in Official_Examples General_Config Smart_Mode Mobile_Modules; do
            if [ -d "$dir" ]; then
              git add "$dir"
            fi
          done

          if git diff --cached --quiet; then
            echo "âœ… é…ç½®å†…å®¹æœªå‘ç”Ÿå˜åŒ–ï¼Œå®‰é™é€€å‡ºï¼ˆæ— æäº¤ï¼‰"
            exit 0
          fi

          git commit -m "ğŸ”„ Update configs"
          git push
