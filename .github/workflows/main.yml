name: Update Configs

on:
  schedule:
    - cron: '30 22 * * *' # UTC 22:30 = åŒ—äº¬æ—¶é—´æ¬¡æ—¥6:30
  workflow_dispatch:
    inputs:
      category:
        description: 'é€‰æ‹©è¦æ›´æ–°çš„ç±»åˆ«'
        required: false
        type: choice
        options:
          - all
          - official
          - general
          - smart
          - mobile
        default: all

permissions:
  contents: write

jobs:
  # ==================================================
  # ç¬¬ä¸€é˜¶æ®µ: å¹¶è¡Œä¸‹è½½æ‰€æœ‰é…ç½®
  # ==================================================
  download-configs:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        category:
          - official
          - general
          - smart
          - mobile
      fail-fast: false
      max-parallel: 4
    
    steps:
      - name: æ£€æŸ¥å­˜å‚¨åº“
        uses: actions/checkout@v4  # ğŸ”§ ä¿®æ­£: v6 ä¸å­˜åœ¨ï¼Œæ”¹ä¸º v4

      - name: åˆ¤æ–­æ˜¯å¦éœ€è¦æ‰§è¡Œ
        id: check_run
        run: |
          should_run=false
          if [[ "${{ github.event_name }}" == "schedule" ]] || \
             [[ "${{ github.event.inputs.category }}" == "all" ]] || \
             [[ "${{ github.event.inputs.category }}" == "${{ matrix.category }}" ]]; then
             should_run=true
          fi
          echo "should_run=$should_run" >> $GITHUB_OUTPUT

      - name: ä¸‹è½½é…ç½®æ–‡ä»¶
        if: steps.check_run.outputs.should_run == 'true'
        id: download
        run: |
          # æ ¹æ®ç±»åˆ«è®¾ç½®ä¸‹è½½è·¯å¾„
          case "${{ matrix.category }}" in
            official)
              target_dir="Official_Examples"
              echo "ğŸ“¥ ä¸‹è½½å®˜æ–¹ç¤ºä¾‹é…ç½®..."
              mkdir -p "$target_dir/Metacubex"
              curl -s -o "$target_dir/Metacubex/rule-set_config.yaml" "https://wiki.metacubex.one/example/mrs"
              curl -s -o "$target_dir/Metacubex/geox_config.yaml" "https://wiki.metacubex.one/example/geox"
              ;;
            
            general)
              target_dir="General_Config"
              echo "ğŸ“¥ ä¸‹è½½é€šç”¨é…ç½®..."
              # åªè¦ç¡®ä¿ bash è„šæœ¬é‡Œæœ‰ mkdir -p General_Config/... å³å¯
              # ä¸ºäº†ä¿é™©ï¼Œè¿™é‡Œå¯ä»¥å…ˆåˆ›å»º
              mkdir -p "$target_dir"
              if [ -f .github/scripts/download-general.sh ]; then
                bash .github/scripts/download-general.sh
              else
                # å¦‚æœæ²¡æœ‰è„šæœ¬ï¼Œæ¼”ç¤ºç”¨ä»£ç (è¯·æ›¿æ¢ä¸ºå®é™…é€»è¾‘æˆ–ä¿ç•™ä½ çš„è„šæœ¬)
                echo "âš ï¸ è„šæœ¬æœªæ‰¾åˆ°ï¼Œä»…åˆ›å»ºç›®å½•ç¤ºä¾‹"
              fi
              ;;
            
            smart)
              target_dir="Smart_Mode"
              echo "ğŸ“¥ ä¸‹è½½Smartæ¨¡å¼é…ç½®..."
              mkdir -p "$target_dir"
              if [ -f .github/scripts/download-smart.sh ]; then bash .github/scripts/download-smart.sh; fi
              ;;
            
            mobile)
              target_dir="Mobile_Modules"
              echo "ğŸ“¥ ä¸‹è½½ç§»åŠ¨æ¨¡å—é…ç½®..."
              mkdir -p "$target_dir"
              if [ -f .github/scripts/download-mobile.sh ]; then bash .github/scripts/download-mobile.sh; fi
              ;;
          esac
          
          # è¾“å‡ºç»™ä¸‹ä¸€æ­¥
          echo "artifact_path=$target_dir" >> $GITHUB_OUTPUT

      # ä¸Šä¼ æ—¶ï¼ŒArtifact ä¼šå‰¥ç¦» artifact_path è¿™ä¸€å±‚æ–‡ä»¶å¤¹
      # ä¾‹å¦‚ï¼šä¸Šä¼  General_Configï¼Œä¸‹è½½æ—¶åªä¼šå¾—åˆ°é‡Œé¢çš„å†…å®¹ï¼ŒGeneral_Config æ–‡ä»¶å¤¹æœ¬èº«ä¸åŒ…å«åœ¨å†…
      - name: ä¸Šä¼  artifact
        uses: actions/upload-artifact@v4
        if: steps.check_run.outputs.should_run == 'true'
        with:
          name: configs-${{ matrix.category }}
          path: ${{ steps.download.outputs.artifact_path }}
          retention-days: 1
          if-no-files-found: ignore

  # ==================================================
  # ç¬¬äºŒé˜¶æ®µ: åˆå¹¶æ‰€æœ‰é…ç½® (å…³é”®ä¿®å¤æ­¥éª¤)
  # ==================================================
  commit-changes:
    needs: download-configs
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: æ£€æŸ¥å­˜å‚¨åº“
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      # ğŸ”§ [å…³é”®ä¿®å¤]ï¼šæ˜¾å¼æŒ‡å®šæ¯ä¸ª artifact ä¸‹è½½åˆ°å“ªä¸ªæ–‡ä»¶å¤¹
      # è¿™æ ·å¯ä»¥é‡å»ºç›®å½•ç»“æ„ï¼Œè€Œä¸æ˜¯å…¨éƒ¨æ•£è½åœ¨æ ¹ç›®å½•
      
      - name: ä¸‹è½½ Official é…ç½®
        uses: actions/download-artifact@v4
        continue-on-error: true # é˜²æ­¢å¹¶æœªè¿è¡Œæ­¤åˆ†ç±»æ—¶æŠ¥é”™
        with:
          name: configs-official
          path: Official_Examples  # ğŸ‘ˆ å¼ºåˆ¶æ”¾å› Official_Examples æ–‡ä»¶å¤¹

      - name: ä¸‹è½½ General é…ç½®
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: configs-general
          path: General_Config     # ğŸ‘ˆ å¼ºåˆ¶æ”¾å› General_Config æ–‡ä»¶å¤¹

      - name: ä¸‹è½½ Smart é…ç½®
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: configs-smart
          path: Smart_Mode         # ğŸ‘ˆ å¼ºåˆ¶æ”¾å› Smart_Mode æ–‡ä»¶å¤¹

      - name: ä¸‹è½½ Mobile é…ç½®
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: configs-mobile
          path: Mobile_Modules     # ğŸ‘ˆ å¼ºåˆ¶æ”¾å› Mobile_Modules æ–‡ä»¶å¤¹

      - name: ç”ŸæˆæŠ¥å‘Šå¹¶æäº¤
        run: |
          echo "ğŸ“ æ£€æŸ¥ç›®å½•ç»“æ„..."
          ls -R
          
          echo "ğŸ“ ç”Ÿæˆæ›´æ–°æŠ¥å‘Š..."
          report="## é…ç½®æ›´æ–°æŠ¥å‘Š - $(date +'%Y-%m-%d %H:%M:%S')\n"
          
          # éå†ç»Ÿè®¡
          for dir in Official_Examples General_Config Smart_Mode Mobile_Modules; do
            if [ -d "$dir" ]; then
              count=$(find "$dir" -type f -name "*.yaml" | wc -l)
              report="${report}\n### ${dir}\n- æ–‡ä»¶æ•°é‡: ${count}\n"
            fi
          done
          
          echo -e "$report" > UPDATE_REPORT.md
          
          # æ£€æŸ¥æ˜¯å¦æœ‰ Git å˜æ›´
          if git diff --quiet; then
            echo "âœ… æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´"
          else
            echo "ğŸ”„ æ£€æµ‹åˆ°å˜æ›´ï¼Œå‡†å¤‡æäº¤..."
            git config --global user.name "github-actions[bot]"
            git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
            
            git add .
            git commit -m "ğŸ”„ è‡ªåŠ¨æ›´æ–°é…ç½® [$(date +'%Y-%m-%d')]" -m "$(cat UPDATE_REPORT.md)"
            git push origin HEAD:${{ github.ref_name }}
            echo "âœ… æ¨é€æˆåŠŸ"
          fi
